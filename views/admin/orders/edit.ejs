<%- include("../../partials/header.ejs") %>
<%- include("../../partials/navbar.ejs") %>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<div class="container">
  <hr>
  <div class="card">
    <div class="card-header">
      <h2>Editar Pedido #<%= order.id %></h2>
    </div>
    <div class="card-body">
      <form method="POST" action="/orders/update/<%= order.id %>">
        
        <label>Cliente:</label>
        <input type="text" class="form-control" value="<%= order.customer.name %>" disabled>
        <br>

        <label>Placa do Veículo:</label>
        <input class="form-control w-30" type="text" name="placa_veiculo" value="<%= order.placa_veiculo %>"><br>

        <div class="card-body">
          <h3 class="card-header">Itens do Pedido</h3><br>
          <div id="itensPedido">
            <% if (order.item_orders && order.item_orders.length > 0) { %>
              <% order.item_orders.forEach(function(item, index) { %>
                <div class="item-container" data-index="<%= index %>">
                  <div class="form-group">
                    <label>Tipo:</label>
                    <select name="itens[<%= index %>][tipo]" class="form-control tipoItem" data-index="<%= index %>">
                      <option value="peca" <%= item.tipo === "peca" ? "selected" : "" %>>Peça</option>
                      <option value="mao_de_obra" <%= item.tipo === "mao_de_obra" ? "selected" : "" %>>Mão de Obra</option>
                    </select>
                  </div>

                  <% if (item.tipo === "peca") { %>
                    <div class="form-group item-peca">
                      <label>Peça:</label>
                      <select name="itens[<%= index %>][part_id]" class="form-control selectPart" 
                              data-index="<%= index %>" data-id="<%= item.part_id %>"></select>
                      <input type="hidden" name="itens[<%= index %>][descricao_hidden]" 
                            class="descricaoItem" value="<%= item.descricao %>">
                    </div>
                  <% } else { %>
                    <div class="form-group item-mao-obra">
                      <label>Descrição:</label>
                      <input type="text" name="itens[<%= index %>][descricao]" class="form-control" value="<%= item.descricao %>">
                    </div>
                  <% } %>

                  <div class="form-group">
                    <label>Quantidade:</label>
                    <input type="number" class="form-control quantidadeItem" 
                          name="itens[<%= index %>][quantidade]" value="<%= item.quantidade %>" min="1">
                  </div>

                  <div class="form-group">
                    <label>Valor:</label>
                    <input type="number" class="form-control valorItem" 
                          name="itens[<%= index %>][valor]" step="0.01" value="<%= item.valor %>">
                  </div>

                  <button type="button" onclick="removerItem(this)" class="btn btn-danger">Remover</button>
                  <hr>
                </div>
              <% }) %>
            <% } %>
          </div>
          <button type="button" class="btn btn-primary" onclick="adicionarItem()">Adicionar Item</button>
        </div>

        <label>Método de Pagamento:</label>
        <select name="metodo_pagamento" class="form-control-sm">
          <option value="dinheiro" <%= order.metodo_pagamento === "dinheiro" ? "selected" : "" %>>Dinheiro</option>
          <option value="cartao" <%= order.metodo_pagamento === "cartao" ? "selected" : "" %>>Cartão</option>
          <option value="boleto" <%= order.metodo_pagamento === "boleto" ? "selected" : "" %>>Boleto</option>
          <option value="pix" <%= order.metodo_pagamento === "pix" ? "selected" : "" %>>PIX</option>
        </select><br>

        <label>Status do Pedido:</label>
        <select name="status_pedido" class="form-control-sm">
          <option value="em andamento" <%= order.status_pedido === "em andamento" ? "selected" : "" %>>Em andamento</option>
          <option value="concluido" <%= order.status_pedido === "concluido" ? "selected" : "" %>>Concluído</option>
        </select><br>

        <label>Observações:</label>
        <textarea name="observacoes" class="form-control"><%= order.observacoes %></textarea><br>

        <button class="btn btn-success">Salvar Alterações</button>
      </form>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<%- include("../../partials/footer.ejs") %>

<script>
      function adicionarItem() {
        const container = document.getElementById("itensPedido");
        const index = container.children.length;

        const html = `
            <div class="item-container" data-index="${index}">
                <div class="form-group">
                    <label>Tipo:</label>
                    <select name="itens[${index}][tipo]" class="form-control tipoItem" data-index="${index}">
                        <option value="peca">Peça</option>
                        <option value="mao_de_obra">Mão de Obra</option>
                    </select>
                </div>

                <div class="form-group item-peca">
                    <label>Peça:</label>
                    <select name="itens[${index}][part_id]" class="form-control selectPart" data-index="${index}"></select>
                    <input type="hidden" name="itens[${index}][descricao_hidden]" class="descricaoItem" >
                </div>

                <div class="form-group item-mao-obra" style="display: none;">
                    <label>Descrição:</label>
                    <input type="text" name="itens[${index}][descricao]" class="form-control" placeholder="Descreva o serviço" >
                </div>

                <div class="form-group">
                    <label>Quantidade:</label>
                    <input type="number" class="form-control quantidadeItem" name="itens[${index}][quantidade]" value="1" min="1" >
                </div>

                <div class="form-group">
                    <label>Valor:</label>
                    <input type="number" class="form-control valorItem" name="itens[${index}][valor]" step="0.01" >
                </div>

                <button type="button" onclick="removerItem(this)" class="btn btn-danger">Remover</button>
                <hr>
            </div>
        `;

        container.insertAdjacentHTML("beforeend", html);
        aplicarSelect2(index);
        atualizarEventosQuantidade();
    }

    function aplicarSelect2(index) {
        const selector = $(`select[name="itens[${index}][part_id]"]`);

        selector.select2({
            ajax: {
                url: '/parts/buscar',
                dataType: 'json',
                delay: 250,
                data: params => ({ termo: params.term }),
                processResults: data => ({
                    results: data.map(part => ({
                        id: part.id,
                        text: part.text,
                        valor: part.valor
                    }))
                })
            },
            placeholder: 'Digite o nome da peça',
            minimumInputLength: 2,
            width: '100%'
        }).on('select2:select', function(e) {
            const valor = parseFloat(e.params.data.valor || 0);
            const final = (valor * 1.5).toFixed(2);

            $(`input[name="itens[${index}][valor]"]`).val(final);
            $(`input[name="itens[${index}][descricao_hidden]"]`).val(e.params.data.text);

            atualizarTotalPedido();
        });
    }

    function atualizarEventosQuantidade() {
        $('input[name^="itens"][name$="[quantidade]"]').off('input').on('input', function () {
            const inputQuantidade = $(this);
            const index = inputQuantidade.closest('.item-container').data('index');
            const quantidade = parseFloat(inputQuantidade.val()) || 1;

            const partSelect = $(`select[name="itens[${index}][part_id]"]`);
            const selectedData = partSelect.select2('data')[0];

            if (selectedData && selectedData.valor) {
                const valorUnitario = parseFloat(selectedData.valor);
                const valorFinal = (valorUnitario * 1.5 * quantidade).toFixed(2);
                $(`input[name="itens[${index}][valor]"]`).val(valorFinal);
            }

            atualizarTotalPedido();
        });
    }

    function atualizarTotalPedido() {
        let total = 0;
        $('.valorItem').each(function () {
            const val = parseFloat($(this).val());
            if (!isNaN(val)) total += val;
        });

        $('#totalPedido').text(`Total do Pedido: R$ ${total.toFixed(2)}`);
    }

    $(document).on('change', '.tipoItem', function () {
        const index = $(this).data('index');
        const container = $(`.item-container[data-index="${index}"]`);
        const tipo = $(this).val();

        if (tipo === 'peca') {
            container.find('.item-peca').show();
            container.find('.item-mao-obra').hide();
        } else {
            container.find('.item-peca').hide();
            container.find('.item-mao-obra').show();
        }

        atualizarTotalPedido();
    });

    function removerItem(botao) {
        $(botao).closest('.item-container').remove();
        atualizarTotalPedido();
    }

    $(".selectPart").each(function() {
      const select = $(this);
      const descricao = select.closest(".item-container").find(".descricaoItem").val();
      const id = select.data("id");

      if (descricao) {
        const option = new Option(descricao, id, true, true);
        select.append(option).trigger("change");
      }
    });
</script>