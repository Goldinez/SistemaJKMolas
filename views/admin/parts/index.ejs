<%- include("../../partials/header.ejs") %>
<%- include("../../partials/navbar.ejs") %>

<div class="container mt-4">
  <h2>Peças Cadastradas</h2>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-success" href="/parts/cadastrar">Cadastrar nova peça</a>
  </div>

  <!-- Filtros -->
  <form method="GET" action="/parts" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control" placeholder="Buscar por nome"
             value="<%= search || '' %>">
    </div>
    <div class="col-md-3">
      <select name="type" class="form-select">
        <option value="">-- Tipo de peça --</option>
        <% types.forEach(t => { %>
          <option value="<%= t.id %>" <%= selectedType == t.id ? "selected" : "" %>>
            <%= t.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="compatibility" class="form-select">
        <option value="">-- Compatibilidade --</option>
        <% compatibilities.forEach(c => { %>
          <option value="<%= c.id %>" <%= selectedCompatibility == c.id ? "selected" : "" %>>
            <%= c.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </form>

  <!-- Tabela -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Fornecedor</th>
        <th>Valor R$</th>
        <th>Tipo Peça</th>
        <th>Marcas Compatíveis</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <% if (parts.length > 0) { %>
        <% parts.forEach(Part => { %>
          <tr>
            <td><%= Part.id %></td>
            <td><%= Part.name %></td>
            <td><%= Part.seller %></td>
            <td>R$ <%= Number(Part.value).toFixed(2) %></td>
            <td><%= Part.type_part ? Part.type_part.name : "" %></td>
            <td>
              <% if (Part.compatibilities && Part.compatibilities.length > 0) { %>
                <% Part.compatibilities.forEach(c => { %>
                  <span class="badge bg-secondary"><%= c.name %></span>
                <% }) %>
              <% } else { %>
                <span class="text-muted">Nenhuma</span>
              <% } %>
            </td>
            <td>
              <a href="/parts/editar/<%= Part.id %>" class="btn btn-sm btn-warning">Editar</a>
              <form method="POST" action="/parts/deletar" style="display:inline" onsubmit="fnConfirmDelete(event, this)">
                <input type="hidden" name="id" value="<%= Part.id %>">
                <button class="btn btn-sm btn-danger">Deletar</button>
              </form>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="7" class="text-center">Nenhuma peça encontrada</td>
        </tr>
      <% } %>
    </tbody>
  </table>

  <!-- Paginação -->
  <nav>
    <ul class="pagination">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === page ? 'active' : '' %>">
          <a class="page-link"
             href="?search=<%= search || '' %>&type=<%= selectedType || '' %>&compatibility=<%= selectedCompatibility || '' %>&page=<%= i %>">
            <%= i %>
          </a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<%- include("../../partials/footer.ejs") %>

<script>
  function fnConfirmDelete(event, form) {
    event.preventDefault();
    var decision = confirm("Você quer deletar essa peça?");
    if (decision) {
      form.submit();
    }
  }
</script>